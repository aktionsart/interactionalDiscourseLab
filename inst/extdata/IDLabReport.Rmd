---
title: "Interactional Discourse Lab \n Generated Report"
output: word_document
---

This report is automatically generated by the interactional discourse lab at [http://interactionalDiscourseLab.net](http://interactionalDiscourseLab.net).

Report generated on ``r date()``.
```{r, echo=FALSE}
secondaryLevel <- hasSecondaryLevelTags(filteredData)
```
```{r, echo=FALSE}
if(secondaryLevel){
  explode <- stringr::str_split_fixed(filteredData$tag, ",", n = 2)
  filteredData$TL <- explode[,1]
  filteredData$SL <- explode[,2]
  TLList <- filteredData$TL %>% unique %>% sort
}

```

# Data summary
- File: ``r filename``
- Unique Speakers:``r paste(sort(unique(filteredData$speaker)))``
- Selected tags: ``r paste(sort(unique(filteredData$tag)))``
- Number of turns: ``r nrow(filteredData)``

# Speakers and tags
## Speaker participation
`r tr("string_SpeakerParticipation")`

```{r, echo=FALSE}
  makeSpeakerParticipationGgplot2(countSpeakers)
```

## Tag use
`r tr("string_TagsUsedByEachSpeaker")`

```{r, echo=FALSE, fig.align='center'}
if(secondaryLevel){
    makeTagBySpeakerNormalisedGgplot2(filteredData %>% dplyr::count(speaker, TL) %>% dplyr::group_by(speaker) %>% dplyr::mutate(proportion = n/sum(n), tag = TL)) %>% print

  for(tl in TLList){
     g <- ggplot(filteredData %>% dplyr::filter(TL == tl) %>% 
                                        dplyr::count(speaker, SL) %>% dplyr::group_by(speaker) %>% 
                                        dplyr::mutate(proportion = n/sum(n))) + 
       geom_bar(aes(x=speaker, y= proportion, fill = SL), position  = "stack", stat='identity', colour = "black") + ggtitle(paste("Category:", tl)) 
     print(g)
     }
  
}  else
  makeTagBySpeakerNormalisedGgplot2(proportionTagPerSpeaker)
```

## Speaker by tag
`r tr("string_SpeakersByTag")`

```{r, echo = FALSE, warning=FALSE, message=FALSE, fig.align='center'}
if(secondaryLevel){
    (makeSpeakerByTagNormalisedGgplot2(filteredData %>% dplyr::count(speaker, TL) %>% dplyr::group_by(TL) %>% dplyr::mutate(proportion = n/sum(n), tag = TL)) + scale_fill_hue()) %>% print

  for(tl in TLList){
     g <- ggplot(filteredData %>% dplyr::filter(TL == tl) %>% 
                                        dplyr::count(speaker, SL) %>% dplyr::group_by(SL) %>% 
                                        dplyr::mutate(proportion = n/sum(n))) + 
       geom_bar(aes(x = SL, y= proportion, fill = speaker), position  = "stack", stat='identity', colour = "black") + ggtitle(paste("Category:", tl)) 
     print(g)
     }
  
}  else
  makeSpeakerByTagNormalisedGgplot2(proportionSpeakerPerTag)
```

# Interactions
`r tr("string_NetworkDescription")`
`r tr("string_ConfidenceInterval")`

*`r tr("string_NetworkNote")`*

## Interactions between tags, for contiguous turns
`r tr("string_TagNetwork")`

```{r, echo=FALSE, fig.align='center'}
if(secondaryLevel){
  countTopLevelTags <- filteredData %>% dplyr::mutate( TL = stringr::str_extract(tag, "^[^,]"))%>% dplyr::count(TL)
  tagSequences <- filteredData %>% makeTurnTaking %>% countTopLevelTagSequence
  plotSequence( tagSequences, countTopLevelTags$n, tr("Category sequences"))
  
  filteredData %>% makeTurnTaking %>% interactionMatrix %>% print
  
  x <- tagSequences %>% addConfidenceIntervals("TL") %>% makeInteractionTable("TL")
  names(x) <- c("", names(x)[-1])
  
} else {
  plotSequence(tagSequences, countTags$n, "Tag types sequences")
  x <- tagSequences %>% addConfidenceIntervals("tag") %>% makeInteractionTable("tag")
  names(x) <- c("", names(x)[-1]) }
```

```{r, echo=FALSE, results='asis'}
  knitr::kable(x, row.names=FALSE)
```


## Interactions between speaker, for contiguous turns
`r tr("string_SpeakerNetwork")`

```{r, echo=FALSE, fig.align='center'}
if(secondaryLevel){
  speakerSequences <- filteredData %>% makeTurnTaking %>% countSpeakerSequence
  plotSequence(speakerSequences, countSpeakers$n, "Contiguous turn takings")
  
} else {  
  plotSequence(speakerSequences, countSpeakers$n, "Contiguous turn takings")}

  x <- speakerSequences %>% addConfidenceIntervals("speaker") %>% makeInteractionTable("speaker")
  names(x) <- c("",names(x)[-1]) 
```

```{r, echo=FALSE, results='asis'}
  knitr::kable(x,row.names=FALSE)
```

# Timelines

## Linear timeline
`r tr("string_TimelineDescription03")`
`r tr("string_TimelineDescription04")`

  ```{r, echo=FALSE, fig.height= 1}
plotTimelineWhole(readFile) %>% print
```

```{r, echo=FALSE}
  if(hasSecondaryLevelTags(readFile))
          plotTimelineWholeTopLevelTags(readFile) %>% print
```
